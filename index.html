<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>YMY COIN</title>
    <style>
        /* --- General Styles --- */
        html, body { height: 100%; margin: 0; overflow-y: auto; font-family: 'Cairo', Arial, sans-serif; }
        body {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            background: #333;
            
        }
        button { cursor: pointer; font-family: inherit; }

        /* --- Ad Banner Container --- */
        #ad-container {
            width: 100%;
            max-width: 450px;
            text-align: center;
            background: #f0f0f0;
            padding: 5px 0;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }

        /* --- Containers --- */
        .page {
            width: 100%; max-width: 450px;
            flex-grow: 1;
            position: relative;
            background: #f0f0f0; display: none; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,.5);
        }
        #game-container { display: flex; }

        /* --- Game UI & Info Bar --- */
        #info-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; font-size: 20px; background: #fff; }
        #view-store-btn, #pause-btn { 
            font-size: 24px; 
            background: none; 
            border: none; 
            padding: 0 10px; 
        }
        #view-store-btn {
            margin-left: auto;
        }

        #game-board { position: relative; flex-grow: 1; background: lightpink; overflow: hidden; border-top: 3px solid #333; border-bottom: 3px solid #333; touch-action: none; }
        #player { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; display: none; object-fit: contain; }

        /* --- Shapes & Animations --- */
        .shape { position: absolute; top: -50px; }
        .circle { width: 40px; height: 40px; background-size: contain; background-position: center; background-repeat: no-repeat; }
        .triangle { width: 40px; height: 40px; background: url('obstacle.png') center/contain no-repeat; }
        .collected-animation { animation: simple-collect 0.2s ease-out; }
        @keyframes simple-collect { 50% { opacity: 0.6; } }

        /* --- Overlays --- */
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,.7);
            color: white; z-index: 10; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box;
        }
        .overlay button { padding: 15px 30px; font-size: 22px; border: none; border-radius: 10px; background: #ffc107; margin-top: 15px; }
        #start-screen .button-group { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; justify-content: center;}
        #start-screen .button-group button { font-size: 18px; padding: 12px 20px; margin-top: 0; }
        #game-over-overlay { display: none; }
        #game-over-overlay h2 { font-size: 32px; margin-bottom: 10px; }

        /* --- Ad Popup Styles --- */
        #ad-popup-overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000; display: none; 
            justify-content: center; align-items: center;
        }
        #ad-popup-content {
            background: #fff; padding: 20px; padding-top: 40px; 
            border-radius: 10px; position: relative; width: 95%;
            max-width: 450px; text-align: center;
        }
        #close-ad-btn {
            position: absolute; top: 5px; left: 10px; 
            background: transparent; border: none; font-size: 28px;
            font-weight: bold; color: #555; cursor: pointer;
            padding: 0 5px; margin: 0;
        }
        
        /* --- Input Fields --- */
        .input-field { padding: 10px; font-size: 18px; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 10px; text-align: center; direction: ltr; width: 80%; }
        #start-btn:disabled { background: #999; cursor: not-allowed; }
        #validation-error { color: #ffc107; font-size: 14px; height: 16px; margin-bottom: 5px; }

        /* --- Controls & Timer --- */
        .time-warning { color: red; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { transform: scale(1.1); } }
        #controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 10%; box-sizing: border-box; }
        #controls button { width: 80px; height: 60px; font-size: 36px; border-radius: 10px; background: rgba(255,255,255,.4); border: 2px solid rgba(255,255,255,.7); }

        /* --- Leaderboard & Store Pages --- */
        #leaderboard-page, #store-page { padding: 20px; box-sizing: border-box; text-align: center; overflow-y: auto; }
        #leaderboard-page h1, #store-page h1 { font-size: 28px; margin-bottom: 20px; }
        #leaderboard-list, #store-item-list { list-style: none; padding: 0; margin: 0; width: 100%; }
        #leaderboard-list li { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: #e9e9e9; border-radius: 8px; font-size: 18px; }
        #leaderboard-list li .name { flex: 1; text-align: right; }
        #leaderboard-list li .score { flex: 0 0 80px; text-align: center; font-weight: bold; }
        #leaderboard-list li:nth-child(1) { background: #ffd700; font-weight: bold; }
        #leaderboard-list li:nth-child(2) { background: #c0c0c0; }
        #leaderboard-list li:nth-child(3) { background: #cd7f32; }
        .back-btn { padding: 15px 40px; font-size: 20px; border-radius: 10px; background: #6c757d; color: white; border: none; margin-top: 20px; }
        
        #store-page #user-balance { font-size: 22px; font-weight: bold; margin-bottom: 20px; background: #fff; padding: 10px; border-radius: 8px; border: 2px solid #ddd; }
        
        .store-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            text-align: right;
            padding: 12px; margin-bottom: 8px; background: #e9e9e9; border-radius: 8px; font-size: 18px;
        }
        .store-item-icon {
            width: 50px;
            height: 50px;
            margin-left: 15px;
            border-radius: 5px;
            background: #fff;
            object-fit: contain;
        }
        .store-item-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .store-item-details { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 5px;}
        .store-item .item-name { flex-grow: 1; }
        .store-item .item-price { font-weight: bold; margin: 0 15px; color: #333; }
        .store-item small { font-size: 14px; color: #555; margin-top: 4px; }
        #store-item-list h2 {
            font-size: 22px;
            text-align: right;
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        #store-item-list h2:first-of-type {
            margin-top: 0;
        }

        /* --- BLOCK TO UPDATE --- */
        .buy-btn, .equip-btn, .unequip-btn { 
            border: none; border-radius: 8px; 
            padding: 10px 15px; font-size: 16px; 
            min-width: 100px;
            cursor: pointer;
        }
        .buy-btn { background: #28a745; color: white; }
        .buy-btn:disabled { background: #999; cursor: not-allowed; }
        .equip-btn { background: #007bff; color: white; }
        .equip-btn.equipped { background: #6c757d; cursor: default; }
        .unequip-btn { background: #dc3545; color: white; } /* Red for unequip */
        
        /* NEW STYLES FOR POWERS */
        .activate-btn {
            background: #ffc107; /* Yellow */
            color: #333;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            min-width: 80px;
            cursor: pointer;
        }
        .power-actions {
            display: flex;
            align-items: center;
            gap: 10px; /* Space between count and button */
        }
        .item-count {
            font-size: 15px;
            font-weight: normal;
            color: #333;
        }
        /* --- END BLOCK TO UPDATE --- */

    </style>
</head>
<body>

<!-- Top Ad Banner -->
<div id="ad-container">
    <div style="flex: 1; text-align: center; padding: 0 5px;">
        <iframe data-aa="2428034" src="//acceptable.a-ads.com/2428034/?size=Adaptive" style="border:0; padding:0; width:100%; height:auto; overflow:hidden; display: block; margin: auto;"></iframe>
    </div>
</div>

<!-- Game Page -->
<div id="game-container" class="page">
    <div id="info-bar">
        <div id="score">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
        <div id="timer">Ø§Ù„ÙˆÙ‚Øª: 00:00</div>
        <button id="view-store-btn">ğŸª</button>
        <button id="pause-btn">â¸</button>
    </div>
    <div id="game-board">
        <div id="start-screen" class="overlay">
            <h1>Ø¥Ø·Ø¹Ø§Ù… Ù…Ø±ÙŠÙˆÙ…Ø©</h1>
            <p>Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹</p>
            <div id="validation-error"></div>
            <input id="insta-user" class="input-field" placeholder="ÙŠÙˆØ²Ø± Ø§Ù„Ø§Ù†Ø³ØªØºØ±Ø§Ù… (@user)" maxlength="30">
            <input type="text" id="private-id" class="input-field" placeholder="Ø§Ù„Ø±Ù…Ø²">
            <div class="button-group">
                <button id="start-btn" disabled>Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
                <button id="view-leaderboard-btn">ğŸ† Ø£ÙØ¶Ù„ 10</button>
            </div>
        </div>
        <div id="game-over-overlay" class="overlay">
            <h2>Ù„Ù„Ø£Ø³ÙØŒ Ø®Ø³Ø±Øª!</h2>
            <p id="final-score-text" style="font-size: 24px;">Ù†Ù‚Ø§Ø·Ùƒ: 0</p>
        </div>
        <img id="player" src="character.png">
        <div id="controls">
            <button id="right-btn">â†’</button>
            <button id="left-btn">â†</button>
        </div>
    </div>
</div>

<!-- Leaderboard Page -->
<div id="leaderboard-page" class="page">
    <h1>ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø£ØºÙ†Ù‰ 10 Ø£Ø¨Ø·Ø§Ù„</h1>
    <ol id="leaderboard-list"><li>ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„...</li></ol>
    <button class="back-btn" id="leaderboard-back-btn">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
</div>

<!-- Store Page -->
<div id="store-page" class="page">
    <h1>ğŸª Ø§Ù„Ù…ØªØ¬Ø±</h1>
    <div id="user-balance">Ø±ØµÙŠØ¯Ùƒ: 0</div>
    <ul id="store-item-list"></ul>
    <button class="back-btn" id="store-back-btn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¨Ø©</button>
</div>

<!-- Ad Popup -->
<div id="ad-popup-overlay">
    <div id="ad-popup-content">
        <button id="close-ad-btn">Ã—</button>
        <div id="frame" style="width: 100%; margin: auto; position: relative; z-index: 99998; display: flex; flex-direction: column; gap: 5px;">
            <!-- Ads are stacked vertically due to flex-direction: column -->
            <iframe data-aa='2428035' src='//acceptable.a-ads.com/2428035/?size=Adaptive' style='border:0; padding:0; width:100%; height:auto; overflow:hidden; display: block; margin: auto;'></iframe>
            <iframe data-aa='2428095' src='//acceptable.a-ads.com/2428095/?size=Adaptive' style='border:0; padding:0; width:100%; height:auto; overflow:hidden; display: block; margin: auto;'></iframe>
        </div>
    </div>
</div>

<audio id="collect-sound" src="collect.mp3"></audio>
<audio id="lose-sound" src="lose.mp3"></audio>
<audio id="background-music" src="background.mp3" loop></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, setDoc, query, orderBy, limit, getDocs, serverTimestamp, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    
    import { initializeStore, renderStore, storeItems } from './store.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDsJ6fm4SFNLnRuHj-b80L0BweGVNkoiIM",
      authDomain: "game-21f55.firebaseapp.com",
      projectId: "game-21f55",
      storageBucket: "game-21f55.firebasestorage.app",
      messagingSenderId: "88852711134",
      appId: "1:88852711134:web:c504445d3d800c3e13244f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const usersRef = collection(db, "users");

    // --- DOM Elements ---
    const elements = {
        pages: document.querySelectorAll('.page'),
        gameContainer: document.getElementById("game-container"),
        leaderboardPage: document.getElementById("leaderboard-page"),
        storePage: document.getElementById("store-page"),
        board: document.getElementById("game-board"),
        player: document.getElementById("player"),
        scoreEl: document.getElementById("score"),
        timerEl: document.getElementById("timer"),
        startScreen: document.getElementById("start-screen"),
        gameOverOverlay: document.getElementById("game-over-overlay"),
        finalScoreText: document.getElementById("final-score-text"),
        leaderboardList: document.getElementById("leaderboard-list"),
        collectSound: document.getElementById("collect-sound"),
        loseSound: document.getElementById("lose-sound"),
        backgroundMusic: document.getElementById("background-music"),
        startBtn: document.getElementById("start-btn"),
        pauseBtn: document.getElementById("pause-btn"),
        viewLeaderboardBtn: document.getElementById("view-leaderboard-btn"),
        viewStoreBtn: document.getElementById("view-store-btn"),
        instaUser: document.getElementById("insta-user"),
        privateIdInput: document.getElementById("private-id"),
        validationError: document.getElementById("validation-error"),
        leaderboardBackBtn: document.getElementById("leaderboard-back-btn"),
        storeBackBtn: document.getElementById("store-back-btn"),
        adPopupOverlay: document.getElementById("ad-popup-overlay"),
        closeAdBtn: document.getElementById("close-ad-btn"),
        userBalance: document.getElementById("user-balance"),
        storeItemList: document.getElementById("store-item-list")
    };
    
    // --- Game State & Config ---
    const INITIAL_TIME = 600;
    const collectibleImages = ['item1.png', 'item2.png', 'item3.png', 'item4.png'];

    let score = 0, time = 0, speed = 6, speedModifier = 1.0;
    let isGameOver = true, isPaused = false, frenzy = false;
    let move = { left: false, right: false };
    let shapeInterval, timerInterval;
    let fallingShapes = [];
    let currentUser = null;
    
    // NEW: State for active powers and their timers
    let activePowers = {
        shield: 0,
        doublePoints: false,
        noTriangles: false,
        attractCircles: false
    };
    let powerTimeouts = [];

    // --- Power Activation Logic ---

    // NEW: Clears all active power timers. Called when a game ends/restarts.
    function clearAllPowerTimeouts() {
        powerTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
        powerTimeouts = [];
    }

    // NEW: This function is called from the store to handle a power's effect.
    function activatePower(itemId) {
        const power = storeItems.powers[itemId];
        if (!power) return;

        switch (itemId) {
            case 'power_shield':
                activePowers.shield++;
                showWelcomeMessage(`ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø¯Ø±Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ©!`);
                break;
            case 'power_double_points':
                activePowers.doublePoints = true;
                const timeout1 = setTimeout(() => {
                    activePowers.doublePoints = false;
                    if (!isGameOver) showWelcomeMessage('Ø§Ù†ØªÙ‡Øª Ù‚ÙˆØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ©.');
                }, 30000); // 30 seconds
                powerTimeouts.push(timeout1);
                break;
            case 'power_no_triangles':
                activePowers.noTriangles = true;
                const timeout2 = setTimeout(() => {
                    activePowers.noTriangles = false;
                    if (!isGameOver) showWelcomeMessage('Ø§Ù†ØªÙ‡Øª Ù‚ÙˆØ© Ø­Ø¬Ø¨ Ø§Ù„Ù…Ø«Ù„Ø«Ø§Øª.');
                }, 30000); // 30 seconds
                powerTimeouts.push(timeout2);
                break;
            case 'power_attract_circles':
                activePowers.attractCircles = true;
                const timeout3 = setTimeout(() => {
                    activePowers.attractCircles = false;
                    if (!isGameOver) showWelcomeMessage('Ø§Ù†ØªÙ‡Øª Ù‚ÙˆØ© Ø¬Ø§Ø°Ø¨ Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±.');
                }, 30000); // 30 seconds
                powerTimeouts.push(timeout3);
                break;
        }
    }

    function applyEquippedItems() {
        if (!currentUser) return;

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ³ØªØ§Ù† Ø§Ù„Ù…Ø¬Ù‡Ø²
        const equippedDressId = currentUser.equipped?.dress;
        if (equippedDressId && equippedDressId !== 'default' && storeItems.dresses[equippedDressId]) {
            elements.player.src = storeItems.dresses[equippedDressId].game_file;
        } else {
            elements.player.src = 'character.png'; 
        }

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¬Ù‡Ø²Ø©
        const equippedBackgroundId = currentUser.equipped?.background;
        if (equippedBackgroundId && equippedBackgroundId !== 'default' && storeItems.backgrounds[equippedBackgroundId]) {
            const backgroundFile = storeItems.backgrounds[equippedBackgroundId].file;
            elements.board.style.background = `url('${backgroundFile}')`;
            elements.board.style.backgroundSize = 'cover';
            elements.board.style.backgroundPosition = 'center';
        } else {
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¬Ù‡ÙŠØ²
            elements.board.style.background = 'lightpink';
        }
    }


    // --- Initialize Store Module ---
    initializeStore({
        db, doc, updateDoc, increment,
        getCurrentUser: () => currentUser,
        updateUser: (updatedUser) => { currentUser = updatedUser; },
        showWelcomeMessage: showWelcomeMessage,
        applyEquippedItems: applyEquippedItems,
        activatePower: activatePower, // MODIFIED: Pass the activation function to the store
        elements: {
            userBalance: elements.userBalance,
            storeItemList: elements.storeItemList
        }
    });

    // --- Page Navigation ---
    function showPage(pageToShow) {
        elements.pages.forEach(p => p.style.display = 'none');
        pageToShow.style.display = 'flex';
    }
    
    elements.viewLeaderboardBtn.onclick = () => {
        loadLeaderboard();
        showPage(elements.leaderboardPage);
    };

    elements.viewStoreBtn.onclick = () => {
        if (!currentUser) { 
            showWelcomeMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø±.");
            return;
        }
        if (!isGameOver) {
            pauseGame();
        }
        renderStore();
        showPage(elements.storePage);
    };

    elements.leaderboardBackBtn.onclick = () => {
        showPage(elements.gameContainer);
        if (currentUser) {
            elements.startScreen.style.display = "none";
            startNewGameRound();
        } else {
            elements.startScreen.style.display = "flex";
        }
    };
    
    elements.storeBackBtn.onclick = () => {
        showPage(elements.gameContainer);
        applyEquippedItems();
        if (currentUser && !isGameOver) {
            resumeGame();
        }
    };

    elements.closeAdBtn.onclick = () => {
        elements.adPopupOverlay.style.display = 'none';
        elements.gameOverOverlay.style.display = 'none';
        loadLeaderboard();
        showPage(elements.leaderboardPage);
    };

    // --- Authentication & Validation ---
    const instaRegex = /^@[a-zA-Z0-9_]{1,30}$/;
    const idRegex = /^[a-zA-Z0-9]{6,}$/;

    function validateInputs() {
        const user = elements.instaUser.value;
        const privateId = elements.privateIdInput.value;
        elements.startBtn.disabled = !(instaRegex.test(user) && idRegex.test(privateId));
    }
    elements.instaUser.addEventListener('input', validateInputs);
    elements.privateIdInput.addEventListener('input', validateInputs);

    elements.startBtn.onclick = async () => {
        const username = elements.instaUser.value;
        const privateId = elements.privateIdInput.value;
        elements.startBtn.disabled = true;
        elements.startBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        elements.validationError.textContent = '';

        try {
            const userDocRef = doc(db, "users", username);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                if (userData.privateId === privateId) {
                    currentUser = { username, ...userData };
                    showWelcomeMessage(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ${username}! Ø±ØµÙŠØ¯Ùƒ: ${currentUser.balance || 0}`);
                    loginSuccess();
                } else {
                    elements.validationError.textContent = 'Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­.';
                }
            } else {
                const newUser = {
                    username, privateId, highScore: 0, balance: 0,
                    inventory: {}, 
                    equipped: { dress: 'default', background: 'default' },
                    createdAt: serverTimestamp()
                };
                await setDoc(userDocRef, newUser);
                currentUser = newUser;
                showWelcomeMessage(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${username}! ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ.`);
                loginSuccess();
            }
        } catch (error) {
            console.error("Auth Error: ", error);
            elements.validationError.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        } finally {
            elements.startBtn.disabled = false;
            elements.startBtn.textContent = 'Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„';
        }
    };
    
    function loginSuccess() {
        localStorage.setItem('savedMariomaUser', JSON.stringify({u: currentUser.username, p: currentUser.privateId}));
        applyEquippedItems();
        elements.startScreen.style.display = "none";
        startNewGameRound();
    }
    
    function runGameIntervals() {
        if (!isPaused) {
            shapeInterval = setInterval(createShape, frenzy ? 450 : 900);
            timerInterval = setInterval(updateTimer, 1000);
            elements.backgroundMusic.play().catch(e => {});
        }
    }
    
    function pauseGame() {
        if (isPaused || isGameOver) return;
        isPaused = true;
        elements.pauseBtn.textContent = 'â–¶ï¸';
        clearInterval(timerInterval); 
        clearInterval(shapeInterval);
        elements.backgroundMusic.pause();
    }

    function resumeGame() {
        if (!isPaused || isGameOver) return; 
        isPaused = false;
        elements.pauseBtn.textContent = 'â¸';
        runGameIntervals();
    }

    function startNewGameRound() {
        // NEW: Reset all active powers and timers for the new round
        clearAllPowerTimeouts();
        activePowers = {
            shield: 0,
            doublePoints: false,
            noTriangles: false,
            attractCircles: false
        };
        
        score = 0; 
        time = INITIAL_TIME; 
        speedModifier = 1.0;
        isGameOver = false;
        isPaused = false;
        frenzy = false;
        
        applyEquippedItems();

        fallingShapes.forEach(s => s.element.remove());
        fallingShapes = [];
        
        elements.scoreEl.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: 0`;
        elements.timerEl.classList.remove("time-warning");
        elements.player.style.display = "block";
        elements.gameOverOverlay.style.display = "none";
        elements.pauseBtn.textContent = 'â¸';
        
        clearInterval(timerInterval); 
        clearInterval(shapeInterval);
        
        elements.backgroundMusic.currentTime = 0;
        
        updateTimer();
        runGameIntervals();
    }
    
    elements.pauseBtn.onclick = () => { 
        isPaused ? resumeGame() : pauseGame(); 
    };

    function updateTimer() {
        if (isGameOver) return;
        const minutes = Math.floor(time / 60).toString().padStart(2, '0');
        const seconds = (time % 60).toString().padStart(2, '0');
        elements.timerEl.textContent = `Ø§Ù„ÙˆÙ‚Øª: ${minutes}:${seconds}`;
        const minutesPassed = Math.floor((INITIAL_TIME - time) / 60);
        speedModifier = 1.0 + (minutesPassed * 0.15); 

        if (!frenzy && time > 0 && time <= (INITIAL_TIME / 2)) {
            frenzy = true;
            elements.timerEl.classList.add("time-warning");
            clearInterval(shapeInterval);
            shapeInterval = setInterval(createShape, 450);
        }
        if (time < 0) {
             winGame();
             return;
        }
        time--;
    }

    function endGame(status) {
        if (isGameOver) return;
        isGameOver = true;
        
        clearAllPowerTimeouts(); // NEW: Clear timers on game end
        clearInterval(timerInterval); 
        clearInterval(shapeInterval);
        elements.backgroundMusic.pause();
        
        saveScore();

        if (status === 'loss') {
            elements.loseSound.play();
            elements.finalScoreText.textContent = `Ù†Ù‚Ø§Ø·Ùƒ: ${score}`;
            elements.gameOverOverlay.style.display = 'flex';
            elements.adPopupOverlay.style.display = 'flex';
        } else {
             setTimeout(() => {
                loadLeaderboard();
                showPage(elements.leaderboardPage);
            }, 500);
        }
    }

    const loseGame = () => endGame('loss');
    const winGame = () => endGame('win');

    async function saveScore() {
        if (!currentUser || score === 0) return;

        const userDocRef = doc(db, "users", currentUser.username);
        const updates = { balance: increment(score) };

        if (score > (currentUser.highScore || 0)) {
            updates.highScore = score;
            currentUser.highScore = score;
        }

        try {
            await updateDoc(userDocRef, updates);
            currentUser.balance = (currentUser.balance || 0) + score;
        } catch(e) {
            console.error("Error saving score:", e);
        }
    }

    async function loadLeaderboard() {
        elements.leaderboardList.innerHTML = "<li>ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„...</li>";
        try {
            const q = query(usersRef, orderBy("balance", "desc"), limit(10));
            const snap = await getDocs(q);
            if (snap.empty) {
                elements.leaderboardList.innerHTML = "<li>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯!</li>";
                return;
            }
            elements.leaderboardList.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                if(data.balance > 0) {
                    const li = document.createElement("li");
                    li.innerHTML = `<span class="name">${data.username}</span><strong class="score">${data.balance}</strong>`;
                    elements.leaderboardList.appendChild(li);
                }
            });
        } catch (error) {
            console.error("Error loading leaderboard: ", error);
            elements.leaderboardList.innerHTML = "<li>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</li>";
        }
    }
    
    // --- MODIFIED Game Loop with Power Logic ---
    function gameLoop(){
        if(!isGameOver && !isPaused){
            if(move.left) movePlayer(-speed);
            if(move.right) movePlayer(speed);

            for(let i=fallingShapes.length-1; i>=0; i--){
                const shapeData=fallingShapes[i];
                shapeData.y += shapeData.fallSpeed;

                // NEW: Attract circles power logic
                if (activePowers.attractCircles && shapeData.element.classList.contains("circle")) {
                    const playerRect = elements.player.getBoundingClientRect();
                    const circleRect = shapeData.element.getBoundingClientRect();
                    const playerCenterX = playerRect.left + (playerRect.width / 2);
                    const circleCenterX = circleRect.left + (circleRect.width / 2);
                    const dx = playerCenterX - circleCenterX;
                    
                    if (Math.abs(dx) > 1) { // Move towards player if not already aligned
                       let currentLeft = parseFloat(shapeData.element.style.left);
                       shapeData.element.style.left = (currentLeft + Math.sign(dx) * 4) + "px"; // Attraction speed = 4
                    }
                }

                shapeData.element.style.top = shapeData.y + "px";

                // MODIFIED: Collision logic with Shield and Double Points
                if(collide(elements.player, shapeData.element)){
                    if(shapeData.element.classList.contains("circle")){
                        const pointsToAdd = activePowers.doublePoints ? 2 : 1;
                        score += pointsToAdd;
                        elements.scoreEl.textContent=`Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}`;
                        elements.collectSound.currentTime=0;
                        elements.collectSound.play();
                        elements.player.classList.add("collected-animation");
                        setTimeout(()=>elements.player.classList.remove("collected-animation"),200);
                        shapeData.element.remove();
                        fallingShapes.splice(i,1)
                    } else { // It's a triangle
                        if (activePowers.shield > 0) { // Check for shield
                            activePowers.shield--; // Consume shield
                            showWelcomeMessage('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø±Ø¹!');
                            // Remove triangle and continue game
                            shapeData.element.remove();
                            fallingShapes.splice(i, 1);
                        } else {
                            loseGame(); // No shield, lose game
                        }
                    }
                } else if(shapeData.y > elements.board.offsetHeight){
                    shapeData.element.remove();
                    fallingShapes.splice(i,1)
                }
            }
        }
        requestAnimationFrame(gameLoop);
    }

    function movePlayer(dx){const x=elements.player.offsetLeft+dx;const max=elements.board.offsetWidth-elements.player.offsetWidth;elements.player.style.left=Math.max(0,Math.min(max,x))+"px"}
    
    // MODIFIED: Shape creation with No Triangles power
    function createShape(){
        const s=document.createElement("div");
        // If 'noTriangles' is active, always create a circle. Otherwise, normal probability.
        if(activePowers.noTriangles || Math.random()<0.7){
            s.className="shape circle";
            const randomImage=collectibleImages[Math.floor(Math.random()*collectibleImages.length)];
            s.style.backgroundImage=`url('${randomImage}')`
        } else {
            s.className="shape triangle"
        }
        s.style.left=Math.random()*(elements.board.offsetWidth-40)+"px";
        elements.board.appendChild(s);
        const baseFallSpeed = (Math.random() * 2 + 1.5); 
        const finalFallSpeed = baseFallSpeed * speedModifier * (frenzy ? 1.6 : 1);
        fallingShapes.push({element:s, y:-50, fallSpeed:finalFallSpeed});
    }

    function collide(a,b){const A=a.getBoundingClientRect();const B=b.getBoundingClientRect();return!(A.right<B.left||A.left>B.right||A.bottom<B.top||A.top>B.bottom)}
    
    document.addEventListener("keydown",e=>{if(e.key==="ArrowLeft")move.left=true;if(e.key==="ArrowRight")move.right=true});
    document.addEventListener("keyup",e=>{if(e.key==="ArrowLeft")move.left=false;if(e.key==="ArrowRight")move.right=false});
    document.querySelector("#left-btn").addEventListener("touchstart",e=>{e.preventDefault();move.left=true});
    document.querySelector("#right-btn").addEventListener("touchstart",e=>{e.preventDefault();move.right=true});
    document.addEventListener("touchend",()=>{move.left=false;move.right=false});
    document.addEventListener("mousedown",e=>{if(e.target.id==='left-btn')move.left=true;if(e.target.id==='right-btn')move.right=true});
    document.addEventListener("mouseup",()=>{move.left=false;move.right=false});
    
    function showWelcomeMessage(message){const div=document.createElement('div');div.textContent=message;Object.assign(div.style,{position:'fixed',top:'20px',left:'50%',transform:'translateX(-50%)',padding:'10px 25px',background:'rgba(40,167,69,0.9)',color:'white',borderRadius:'10px',zIndex:'1000',fontSize:'18px',fontWeight:'bold',boxShadow:'0 4px 10px rgba(0,0,0,0.2)'});document.body.appendChild(div);setTimeout(()=>{div.style.transition='opacity 0.5s';div.style.opacity='0';setTimeout(()=>div.remove(),500)},3500)}
    function loadSavedUser(){const savedUserStr=localStorage.getItem('savedMariomaUser');if(savedUserStr){try{const savedUser=JSON.parse(savedUserStr);elements.instaUser.value=savedUser.u;elements.privateIdInput.value=savedUser.p;validateInputs()}catch(e){localStorage.removeItem('savedMariomaUser')}}}

    showPage(elements.gameContainer);
    loadSavedUser();
    gameLoop(); // Start the single game loop once.
</script>

</body>
</html>
