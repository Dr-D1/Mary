<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>YMY COIN - Ø§Ù„Ù„Ø¹Ø¨Ø©</title>
    <style>
        html, body { height: 100%; margin: 0; overflow-y: auto; font-family: 'Cairo', Arial, sans-serif; }
        body { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; background: #333; }
        button { cursor: pointer; font-family: inherit; }
        .page { width: 100%; max-width: 450px; flex-grow: 1; position: relative; background: #f0f0f0; display: none; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,.5); }
        #game-container { display: none; } /* ÙŠØ¨Ø¯Ø£ Ù…Ø®ÙÙŠØ§Ù‹ Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        #info-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; font-size: 20px; background: #fff; }
        #view-store-btn, #pause-btn { font-size: 24px; background: none; border: none; padding: 0 10px; }
        #view-store-btn { margin-left: auto; }
        #game-board { position: relative; flex-grow: 1; background: lightpink; overflow: hidden; border-top: 3px solid #333; border-bottom: 3px solid #333; touch-action: none; }
        #player { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; display: none; object-fit: contain; }
        .shape { position: absolute; top: -50px; }
        .circle { width: 40px; height: 40px; background-size: contain; background-position: center; background-repeat: no-repeat; }
        .triangle { width: 40px; height: 40px; background: url('obstacle.png') center/contain no-repeat; }
        .collected-animation { animation: simple-collect 0.2s ease-out; }
        @keyframes simple-collect { 50% { opacity: 0.6; } }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,.7); color: white; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .overlay button { padding: 15px 30px; font-size: 22px; border: none; border-radius: 10px; background: #ffc107; margin-top: 15px; }
        #game-over-overlay { display: none; }
        #game-over-overlay h2 { font-size: 32px; margin-bottom: 10px; }
        #game-over-continue-btn { font-size: 20px; }
        .time-warning { color: red; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { transform: scale(1.1); } }
        #controls { position: absolute; bottom: 60px; width: 100%; display: flex; justify-content: space-between; padding: 0 10%; box-sizing: border-box; z-index: 5; }
        #controls button { width: 80px; height: 60px; font-size: 36px; border-radius: 10px; background: rgba(255,255,255,.4); border: 2px solid rgba(255,255,255,.7); }
        #sticky-banner-container { margin-top: 20px; text-align: center; }
        #interstitial-ad-overlay { background: rgba(0, 0, 0, 0.9); z-index: 2100; }
        #interstitial-ad-content { background: #fff; padding: 20px; border-radius: 10px; position: relative; width: 95%; max-width: 340px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #close-interstitial-btn { padding: 10px 25px; font-size: 16px; border: none; border-radius: 8px; background: #6c757d; color: white; margin-top: 15px; }
        #leaderboard-page, #store-page { padding: 20px; box-sizing: border-box; text-align: center; overflow-y: auto; }
        #leaderboard-page h1, #store-page h1 { font-size: 28px; margin-bottom: 20px; }
        #leaderboard-list, #store-item-list { list-style: none; padding: 0; margin: 0; width: 100%; }
        #leaderboard-list li { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: #e9e9e9; border-radius: 8px; font-size: 18px; }
        #leaderboard-list li .name { flex: 1; text-align: right; }
        #leaderboard-list li .score { flex: 0 0 80px; text-align: center; font-weight: bold; }
        #leaderboard-list li:nth-child(1) { background: #ffd700; font-weight: bold; }
        #leaderboard-list li:nth-child(2) { background: #c0c0c0; }
        #leaderboard-list li:nth-child(3) { background: #cd7f32; }
        .back-btn { padding: 15px 40px; font-size: 20px; border-radius: 10px; background: #6c757d; color: white; border: none; margin-top: 20px; }
        #store-page #user-balance { font-size: 22px; font-weight: bold; margin-bottom: 20px; background: #fff; padding: 10px; border-radius: 8px; border: 2px solid #ddd; }
        .store-item { display: flex; flex-direction: row; align-items: center; text-align: right; padding: 12px; margin-bottom: 8px; background: #e9e9e9; border-radius: 8px; font-size: 18px; }
        .store-item-icon { width: 50px; height: 50px; margin-left: 15px; border-radius: 5px; background: #fff; object-fit: contain; }
        .store-item-main { flex-grow: 1; display: flex; flex-direction: column; }
        .store-item-details { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 5px;}
        .store-item .item-name { flex-grow: 1; }
        .store-item .item-price { font-weight: bold; margin: 0 15px; color: #333; }
        .store-item small { font-size: 14px; color: #555; margin-top: 4px; }
        #store-item-list h2 { font-size: 22px; text-align: right; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px; }
        #store-item-list h2:first-of-type { margin-top: 0; }
        .buy-btn, .equip-btn, .unequip-btn { border: none; border-radius: 8px; padding: 10px 15px; font-size: 16px; min-width: 100px; cursor: pointer; }
        .buy-btn { background: #28a745; color: white; }
        .buy-btn:disabled { background: #999; cursor: not-allowed; }
        .equip-btn { background: #007bff; color: white; }
        .equip-btn.equipped { background: #6c757d; cursor: default; }
        .unequip-btn { background: #dc3545; color: white; }
        .activate-btn { background: #ffc107; color: #333; border: none; border-radius: 8px; padding: 10px 15px; font-size: 16px; font-weight: bold; min-width: 80px; cursor: pointer; }
        .power-actions { display: flex; align-items: center; gap: 10px; }
        .item-count { font-size: 15px; font-weight: normal; color: #333; }
        #welcome-popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 15px 25px; border-radius: 10px; z-index: 3000; font-size: 18px; display: none; animation: fadeInOut 3s forwards; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 20%, 80% { opacity: 1; } }
    </style>
   <meta name="monetag" content="7c8a5381880da2d1279fc5ededb73d5d">
</head>
<body>

<!-- ØµÙØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
<div id="game-container" class="page">
    <div id="info-bar">
        <div id="score">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
        <div id="timer">Ø§Ù„ÙˆÙ‚Øª: 00:00</div>
        <button id="view-store-btn">ğŸª</button>
        <button id="pause-btn">â¸</button>
    </div>
    <div id="game-board">
        <div id="game-over-overlay" class="overlay">
            <h2>Ù„Ù„Ø£Ø³ÙØŒ Ø®Ø³Ø±Øª!</h2>
            <p id="final-score-text" style="font-size: 24px;">Ù†Ù‚Ø§Ø·Ùƒ: 0</p>
            <button id="game-over-continue-btn">ğŸ† Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨</button>
        </div>
        <img id="player" src="character.png">
        <div id="controls">
            <button id="right-btn">â†’</button>
            <button id="left-btn">â†</button>
        </div>
        <div id="sticky-banner-container">
            <!-- Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨Ø§Ù†Ø± -->
            <script>
              atOptions = { 'key' : '02c5d8747c99096b5b799dfc18c349ad', 'format' : 'iframe', 'height' : 60, 'width' : 468, 'params' : {} };
            </script>
            <script src="https://www.highperformanceformat.com/02c5d8747c99096b5b799dfc18c349ad/invoke.js"></script>
        </div>
    </div>
</div>

<!-- ØµÙØ­Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† -->
<div id="leaderboard-page" class="page">
    <h1>ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø£ØºÙ†Ù‰ 10 Ø£Ø¨Ø·Ø§Ù„</h1>
    <ol id="leaderboard-list"></ol>
    <button class="back-btn" id="leaderboard-back-btn">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø± -->
<div id="store-page" class="page">
    <h1>ğŸª Ø§Ù„Ù…ØªØ¬Ø±</h1>
    <div id="user-balance">Ø±ØµÙŠØ¯Ùƒ: 0</div>
    <ul id="store-item-list"></ul>
    <button class="back-btn" id="store-back-btn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¨Ø©</button>
</div>

<!-- Ø¥Ø¹Ù„Ø§Ù† Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© -->
<div id="interstitial-ad-overlay" class="overlay" style="display: none;">
    <div id="interstitial-ad-content">
         <p style="color: #333; margin-bottom: 15px;">...ÙŠØ³ØªØ£Ù†Ù Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„</p>
         <script>
          atOptions = { 'key' : 'a76580847d6d6c1519c5508135102b18', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
         </script>
         <script src="https://www.highperformanceformat.com/a76580847d6d6c1519c5508135102b18/invoke.js"></script>
         <button id="close-interstitial-btn" style="display: none;">ØªØ®Ø·ÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
    </div>
</div>

<div id="welcome-popup"></div>

<audio id="collect-sound" src="collect.mp3"></audio>
<audio id="lose-sound" src="lose.mp3"></audio>
<audio id="background-music" src="background.mp3" loop></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, query, orderBy, limit, getDocs, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { initializeStore, renderStore, storeItems } from './store.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDsJ6fm4SFNLnRuHj-b80L0BweGVNkoiIM",
      authDomain: "game-21f55.firebaseapp.com",
      projectId: "game-21f55",
      storageBucket: "game-21f55.firebasestorage.app",
      messagingSenderId: "88852711134",
      appId: "1:88852711134:web:c504445d3d800c3e13244f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const usersRef = collection(db, "users");

    const elements = {
        pages: document.querySelectorAll('.page'),
        gameContainer: document.getElementById("game-container"),
        leaderboardPage: document.getElementById("leaderboard-page"),
        storePage: document.getElementById("store-page"),
        board: document.getElementById("game-board"),
        player: document.getElementById("player"),
        scoreEl: document.getElementById("score"),
        timerEl: document.getElementById("timer"),
        gameOverOverlay: document.getElementById("game-over-overlay"),
        finalScoreText: document.getElementById("final-score-text"),
        leaderboardList: document.getElementById("leaderboard-list"),
        collectSound: document.getElementById("collect-sound"),
        loseSound: document.getElementById("lose-sound"),
        backgroundMusic: document.getElementById("background-music"),
        pauseBtn: document.getElementById("pause-btn"),
        viewStoreBtn: document.getElementById("view-store-btn"),
        leaderboardBackBtn: document.getElementById("leaderboard-back-btn"),
        storeBackBtn: document.getElementById("store-back-btn"),
        userBalance: document.getElementById("user-balance"),
        storeItemList: document.getElementById("store-item-list"),
        interstitialAdOverlay: document.getElementById("interstitial-ad-overlay"),
        closeInterstitialBtn: document.getElementById("close-interstitial-btn"),
        gameOverContinueBtn: document.getElementById("game-over-continue-btn"),
        welcomePopup: document.getElementById("welcome-popup")
    };

    const INITIAL_TIME = 600;
    const collectibleImages = ['item1.png', 'item2.png', 'item3.png', 'item4.png'];
    let score = 0, time = 0, speed = 6, speedModifier = 1.0;
    let isGameOver = true, isPaused = false, frenzy = false;
    let move = { left: false, right: false };
    let shapeInterval, timerInterval;
    let fallingShapes = [];
    let currentUser = null;
    let lossCount = 0;
    let gamesPlayed = 0;
    let lastInterstitialTime = 0;
    const INTERSTITIAL_COOLDOWN = 120000;
    let activePowers = { shield: 0, doublePoints: false, noTriangles: false, attractCircles: false };
    let powerTimeouts = [];

    // --- NEW Game Initializer ---
    async function initializeGame() {
        const savedUserStr = localStorage.getItem('savedMariomaUser');
        if (!savedUserStr) {
            window.location.href = 'registration.html';
            return;
        }

        const savedUser = JSON.parse(savedUserStr);
        if (!savedUser.u || !savedUser.p) {
            window.location.href = 'registration.html';
            return;
        }

        try {
            const userDocRef = doc(db, "users", savedUser.u);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists() && userDoc.data().privateId === savedUser.p) {
                currentUser = { username: savedUser.u, ...userDoc.data() };
                showWelcomeMessage(`Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ${currentUser.username}!`);
                
                showPage(elements.gameContainer);
                applyEquippedItems();
                startNewGameRound();
                gameLoop();
            } else {
                localStorage.removeItem('savedMariomaUser');
                window.location.href = 'registration.html';
            }
        } catch (error) {
            console.error("Failed to initialize game:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ. Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");
            window.location.href = 'registration.html';
        }
    }
    
    function clearAllPowerTimeouts() {
        powerTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
        powerTimeouts = [];
    }
    
    function activatePower(itemId, duration = 10000) {
        showWelcomeMessage(`ØªÙ… ØªÙØ¹ÙŠÙ„ ${storeItems[itemId].name}!`);
        switch (itemId) {
            case 'shield':
                activePowers.shield += 1;
                showWelcomeMessage(`Ù„Ø¯ÙŠÙƒ ${activePowers.shield} Ø¯Ø±Ø¹`);
                break;
            case 'doublePoints':
                activePowers.doublePoints = true;
                const doubleTimeout = setTimeout(() => { activePowers.doublePoints = false; showWelcomeMessage('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø©'); }, duration);
                powerTimeouts.push(doubleTimeout);
                break;
            case 'noTriangles':
                activePowers.noTriangles = true;
                const noTrianglesTimeout = setTimeout(() => { activePowers.noTriangles = false; showWelcomeMessage('Ø¹Ø§Ø¯Øª Ø§Ù„Ù…Ø«Ù„Ø«Ø§Øª Ù„Ù„Ø¸Ù‡ÙˆØ±'); }, duration);
                powerTimeouts.push(noTrianglesTimeout);
                break;
            case 'attractCircles':
                activePowers.attractCircles = true;
                const attractTimeout = setTimeout(() => { activePowers.attractCircles = false; showWelcomeMessage('Ø§Ù†ØªÙ‡Ù‰ Ù…ÙØ¹ÙˆÙ„ Ø§Ù„Ø¬Ø°Ø¨'); }, duration);
                powerTimeouts.push(attractTimeout);
                break;
        }
        renderStore();
    }
    
    function applyEquippedItems() {
        if (!currentUser || !currentUser.equipped) return;
        const dress = currentUser.equipped.dress;
        const background = currentUser.equipped.background;

        if (dress && storeItems[dress]) {
            elements.player.src = storeItems[dress].icon;
        } else {
            elements.player.src = 'character.png'; 
        }

        if (background && storeItems[background]) {
            elements.board.style.backgroundImage = `url('${storeItems[background].icon}')`;
            elements.board.style.backgroundSize = 'cover';
            elements.board.style.backgroundPosition = 'center';
        } else {
            elements.board.style.backgroundImage = "lightpink";
        }
    }

    initializeStore({ db, doc, updateDoc, increment, getCurrentUser: () => currentUser, updateUser: (updatedUser) => { currentUser = updatedUser; }, showWelcomeMessage: showWelcomeMessage, applyEquippedItems: applyEquippedItems, activatePower: activatePower, elements: { userBalance: elements.userBalance, storeItemList: elements.storeItemList }});
    
    function showPage(pageToShow) {
        elements.pages.forEach(p => p.style.display = 'none');
        pageToShow.style.display = 'flex';
    }

    elements.viewStoreBtn.onclick = () => {
        if (!isGameOver) pauseGame();
        renderStore();
        showPage(elements.storePage);
    };

    elements.leaderboardBackBtn.onclick = () => {
        showPage(elements.gameContainer);
        startNewGameRound();
    };

    elements.storeBackBtn.onclick = () => {
        window.open('https://www.effectivegatecpm.com/cb2brupa8?key=6aa708ffff9d6c906f123379548bbe58', '_blank');
        showPage(elements.gameContainer);
        applyEquippedItems();
        if (!isGameOver) resumeGame();
    };

    elements.gameOverContinueBtn.onclick = () => {
        elements.gameOverOverlay.style.display = 'none';
        loadLeaderboard();
        showPage(elements.leaderboardPage);
    };

    elements.closeInterstitialBtn.onclick = () => {
        elements.interstitialAdOverlay.style.display = 'none';
        elements.gameOverOverlay.style.display = 'none';
        loadLeaderboard();
        showPage(elements.leaderboardPage);
    };

    function runGameIntervals() {
        if (!isPaused) {
            shapeInterval = setInterval(createShape, frenzy ? 450 : 900);
            timerInterval = setInterval(updateTimer, 1000);
            elements.backgroundMusic.play().catch(e => {});
        }
    }

    function pauseGame() {
        if (isPaused || isGameOver) return;
        isPaused = true;
        elements.pauseBtn.textContent = 'â–¶ï¸';
        clearInterval(timerInterval);
        clearInterval(shapeInterval);
        elements.backgroundMusic.pause();
    }

    function resumeGame() {
        if (!isPaused || isGameOver) return;
        isPaused = false;
        elements.pauseBtn.textContent = 'â¸';
        runGameIntervals();
    }
    
    function startNewGameRound() {
        gamesPlayed++;
        clearAllPowerTimeouts();
        activePowers = { shield: 0, doublePoints: false, noTriangles: false, attractCircles: false };
        score = 0;
        time = INITIAL_TIME;
        speedModifier = 1.0;
        isGameOver = false;
        isPaused = false;
        frenzy = false;
        applyEquippedItems();
        fallingShapes.forEach(s => s.element.remove());
        fallingShapes = [];
        elements.scoreEl.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: 0`;
        elements.timerEl.classList.remove("time-warning");
        elements.player.style.display = "block";
        elements.gameOverOverlay.style.display = "none";
        elements.pauseBtn.textContent = 'â¸';
        clearInterval(timerInterval);
        clearInterval(shapeInterval);
        elements.backgroundMusic.currentTime = 0;
        updateTimer();
        runGameIntervals();
    }

    elements.pauseBtn.onclick = () => { isPaused ? resumeGame() : pauseGame(); };

    function updateTimer() {
        if (isGameOver) return;
        const minutes = Math.floor(time / 60).toString().padStart(2, '0');
        const seconds = (time % 60).toString().padStart(2, '0');
        elements.timerEl.textContent = `Ø§Ù„ÙˆÙ‚Øª: ${minutes}:${seconds}`;
        const minutesPassed = Math.floor((INITIAL_TIME - time) / 60);
        speedModifier = 1.0 + (minutesPassed * 0.15);
        if (!frenzy && time > 0 && time <= (INITIAL_TIME / 2)) {
            frenzy = true;
            elements.timerEl.classList.add("time-warning");
            clearInterval(shapeInterval);
            shapeInterval = setInterval(createShape, 450);
        }
        if (time < 0) {
            winGame();
            return;
        }
        time--;
    }
    
    function endGame(status) {
        if (isGameOver) return;
        isGameOver = true;
        clearAllPowerTimeouts();
        clearInterval(timerInterval);
        clearInterval(shapeInterval);
        elements.backgroundMusic.pause();
        saveScore();
        if (status === 'loss') {
            lossCount++;
            elements.loseSound.play();
            elements.finalScoreText.textContent = `Ù†Ù‚Ø§Ø·Ùƒ: ${score}`;
            elements.gameOverOverlay.style.display = 'flex';
            maybeShowInterstitial();
        } else {
            setTimeout(() => {
                loadLeaderboard();
                showPage(elements.leaderboardPage);
            }, 500);
        }
    }

    const loseGame = () => endGame('loss');
    const winGame = () => endGame('win');

    function maybeShowInterstitial() {
        const now = Date.now();
        if (gamesPlayed > 1 && lossCount % 2 === 0 && (now - lastInterstitialTime > INTERSTITIAL_COOLDOWN)) {
            lastInterstitialTime = now;
            elements.gameOverContinueBtn.style.display = 'none';
            elements.interstitialAdOverlay.style.display = 'flex';
            elements.closeInterstitialBtn.style.display = 'none';
            setTimeout(() => {
                elements.closeInterstitialBtn.style.display = 'inline-block';
            }, 5000);
        } else {
            elements.gameOverContinueBtn.style.display = 'block';
        }
    }
    
    async function saveScore() {
        if (!currentUser || score === 0) return;
        const userDocRef = doc(db, "users", currentUser.username);
        const updates = { balance: increment(score) };
        if (score > (currentUser.highScore || 0)) {
            updates.highScore = score;
            currentUser.highScore = score;
        }
        try {
            await updateDoc(userDocRef, updates);
            currentUser.balance += score;
        } catch(e) { console.error("Error saving score:", e); }
    }
    
    async function loadLeaderboard() {
        elements.leaderboardList.innerHTML = '<li>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨...</li>';
        try {
            const q = query(usersRef, orderBy("highScore", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            elements.leaderboardList.innerHTML = '';
            let rank = 1;
            querySnapshot.forEach(doc => {
                const user = doc.data();
                const li = document.createElement('li');
                li.innerHTML = `<span class="rank">${rank++}.</span> <span class="name">${user.username}</span> <span class="score">${user.highScore || 0}</span>`;
                elements.leaderboardList.appendChild(li);
            });
        } catch (error) {
            elements.leaderboardList.innerHTML = '<li>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨.</li>';
            console.error("Error loading leaderboard:", error);
        }
    }

    function gameLoop() {
        if (!isGameOver && !isPaused) {
            if (move.left) movePlayer(-speed);
            if (move.right) movePlayer(speed);

            for (let i = fallingShapes.length - 1; i >= 0; i--) {
                const shapeData = fallingShapes[i];
                shapeData.y += shapeData.fallSpeed;

                if (activePowers.attractCircles && shapeData.element.classList.contains("circle")) {
                    const playerRect = elements.player.getBoundingClientRect();
                    const shapeRect = shapeData.element.getBoundingClientRect();
                    const playerCenterX = playerRect.left + playerRect.width / 2;
                    const shapeCenterX = shapeRect.left + shapeRect.width / 2;
                    if (Math.abs(playerCenterX - shapeCenterX) < 150) { 
                         shapeData.x += (playerCenterX - shapeCenterX) * 0.05; 
                         shapeData.element.style.left = shapeData.x + "px";
                    }
                }

                shapeData.element.style.top = shapeData.y + "px";

                if (collide(elements.player, shapeData.element)) {
                    if (shapeData.element.classList.contains("circle")) {
                        score += activePowers.doublePoints ? 2 : 1;
                        elements.scoreEl.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}`;
                        elements.collectSound.play();
                        shapeData.element.remove();
                        fallingShapes.splice(i, 1);
                    } else { // Triangle
                        if (activePowers.shield > 0) {
                            activePowers.shield--;
                            showWelcomeMessage(`ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø±Ø¹! Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${activePowers.shield}`);
                            renderStore(); // Update store view
                            shapeData.element.remove();
                            fallingShapes.splice(i, 1);
                        } else {
                            loseGame();
                        }
                    }
                } else if (shapeData.y > elements.board.offsetHeight) {
                    shapeData.element.remove();
                    fallingShapes.splice(i, 1);
                }
            }
        }
        requestAnimationFrame(gameLoop);
    }
    
    function movePlayer(dx) {
        const x = elements.player.offsetLeft + dx;
        const max = elements.board.offsetWidth - elements.player.offsetWidth;
        elements.player.style.left = Math.max(0, Math.min(max, x)) + "px";
    }

    function createShape() {
        const isTriangle = Math.random() < 0.25 && !activePowers.noTriangles;
        const element = document.createElement("div");
        element.classList.add("shape");
        if (isTriangle) {
            element.classList.add("triangle");
        } else {
            element.classList.add("circle");
            const randomImage = collectibleImages[Math.floor(Math.random() * collectibleImages.length)];
            element.style.backgroundImage = `url('${randomImage}')`;
        }

        const x = Math.random() * (elements.board.offsetWidth - 40);
        element.style.left = x + "px";

        elements.board.appendChild(element);
        fallingShapes.push({
            element: element,
            y: -50,
            x: x,
            fallSpeed: (Math.random() * 2 + 2) * speedModifier
        });
    }

    function collide(a, b) {
        const A = a.getBoundingClientRect();
        const B = b.getBoundingClientRect();
        return !(A.right < B.left || A.left > B.right || A.bottom < B.top || A.top > B.bottom);
    }

    document.addEventListener("keydown", e => { if (e.key === "ArrowLeft") move.left = true; if (e.key === "ArrowRight") move.right = true; });
    document.addEventListener("keyup", e => { if (e.key === "ArrowLeft") move.left = false; if (e.key === "ArrowRight") move.right = false; });
    document.querySelector("#left-btn").addEventListener("touchstart", e => { e.preventDefault(); move.left = true; });
    document.querySelector("#right-btn").addEventListener("touchstart", e => { e.preventDefault(); move.right = true; });
    document.addEventListener("touchend", () => { move.left = false; move.right = false; });
    document.addEventListener("mousedown", e => { if (e.target.id === 'left-btn') move.left = true; if (e.target.id === 'right-btn') move.right = true; });
    document.addEventListener("mouseup", () => { move.left = false; move.right = false; });
    
    function showWelcomeMessage(message) {
        const popup = elements.welcomePopup;
        popup.textContent = message;
        popup.style.display = 'block';
        setTimeout(() => {
            popup.style.display = 'none';
        }, 3000);
    }

    // --- Initial Load ---
    initializeGame();
</script>

</body>
</html>
